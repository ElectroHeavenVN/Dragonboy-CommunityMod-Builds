name: Biên dịch dự án (QLTK, Game)

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  check-commit:
    name: Kiểm tra commit mới
    runs-on: windows-latest
    outputs:
      cancel: ${{ steps.check_hash.outputs.cancel }}
    strategy:
      fail-fast: false
    env:
      cache-key: latest-commit
    permissions:
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.1
      - name: Lấy hash commit mới nhất của branch Unity-project
        run: |
          $commit = git ls-remote https://github.com/pk9r327/Dragonboy.git Unity-project
          $hash = $commit.Split("`t")[0]
          echo "LATEST_COMMIT=$hash" | Out-File -FilePath $env:GITHUB_ENV -Append
      - name: Cache hash commit
        id: cache-restore
        uses: actions/cache/restore@v4.0.2
        with:
          path: latest-commit.txt
          key: ${{ env.cache-key }}
      - name: kiểm tra hash
        id: check_hash
        run: $hash = "${{ env.LATEST_COMMIT }}"; if ((Test-Path latest-commit.txt -PathType Leaf)) { $commitContent = Get-Content -Path latest-commit.txt; $output = ($commitContent -eq $hash).ToString().ToLower(); } else { $output = "false" } $output = "cancel=$output".ToString().ToLower(); echo $output | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append
      - name: Lấy hash commit mới nhất
        run: echo "${{ env.LATEST_COMMIT }}" > latest-commit.txt
      - name: Xóa cache trước đó
        if: ${{ steps.cache-restore.outputs.cache-hit }}
        continue-on-error: true
        run: gh cache delete "${{ env.cache-key }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Lưu cache mới
        uses: actions/cache/save@v4.0.2
        with: 
          path: latest-commit.txt
          key: ${{ env.cache-key }}
  build-Account-Manager:
    name: Biên dịch QLTK (Windows, ${{ matrix.configuration }}, .NET 8.0)
    needs: [check-commit]
    if: needs.check-commit.outputs.cancel == 'false'
    strategy:
      matrix:
        configuration: [Debug, Release]
    runs-on: windows-latest
    env:
      Solution-Path: QLTK\QLTK.sln
    steps:
    - name: Clone pk9r327/Dragonboy branch Unity-project
      uses: actions/checkout@v4.1.1
      with:
        repository: pk9r327/Dragonboy
        ref: Unity-project
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    - name: Setup NuGet
      uses: nuget/setup-nuget@v2
    - name: Khôi phục dự án
      run: msbuild ${{ env.Solution-Path }} /t:Restore /p:Configuration=$env:Configuration && nuget restore ${{ env.Solution-Path }}
      env:
        Configuration: ${{ matrix.configuration }}
    - name: Biên dịch dự án
      run: msbuild ${{ env.Solution-Path }} -t:rebuild -property:Configuration=$env:Configuration
      env:
        Configuration: ${{ matrix.configuration }}
    - name: Upload file đã biên dịch
      uses: actions/upload-artifact@v4.3.1
      with:
        name: QLTK-${{ matrix.configuration }}
        path: QLTK/bin/${{ matrix.configuration }}
  build-Unity-Windows:
    name: Biên dịch ${{ matrix.targetPlatform }} ${{ matrix.scriptingBackend }} trên máy chủ Windows
    needs: [check-commit]
    if: needs.check-commit.outputs.cancel == 'false'
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        targetPlatform:
          - StandaloneWindows 
          - StandaloneWindows64 
        scriptingBackend:
          - Mono # 0
          - IL2CPP # 1
    permissions:
      actions: write
    steps:
      - name: Clone pk9r327/Dragonboy branch Unity-project
        uses: actions/checkout@v4.1.1
        with:
          repository: pk9r327/Dragonboy
          ref: Unity-project
      - name: Cache
        id: cache-restore
        uses: actions/cache@v4.0.2
        with:
          path: GameProject/DragonBoy/Library
          key: Library-${{ matrix.targetPlatform }}
      - name: Đổi scripting backend thành ${{ matrix.scriptingBackend }}
        run: cd GameProject && pwsh ./set_scripting_backend.ps1 -projectSettingsPath "DragonBoy/ProjectSettings/ProjectSettings.asset" -platform ${{ matrix.targetPlatform }} -scriptingBackend ${{ matrix.scriptingBackend }} || powershell ./set_scripting_backend.ps1 -projectSettingsPath "DragonBoy/ProjectSettings/ProjectSettings.asset" -platform ${{ matrix.targetPlatform }} -scriptingBackend ${{ matrix.scriptingBackend }};     
      - name: Biên dịch dự án
        uses: game-ci/unity-builder@v4.2.3
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: ${{ matrix.targetPlatform }}
          projectPath: GameProject/DragonBoy
          buildName: DragonBoy
          allowDirtyBuild: true          
      - name: Upload file game đã biên dịch
        uses: actions/upload-artifact@v4.3.1
        with:
          name: Build-${{ matrix.targetPlatform }}-${{ matrix.scriptingBackend }}
          path: build/${{ matrix.targetPlatform }}
      - name: Xóa cache trước đó
        if: ${{ steps.cache-restore.outputs.cache-hit }}
        continue-on-error: true
        run: |
          gh cache delete "Library-${{ matrix.targetPlatform }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Lưu cache
        uses: actions/cache/save@v4.0.2
        with: 
          path: GameProject/DragonBoy/Library
          key: Library-${{ matrix.targetPlatform }}
  build-Unity-Linux:
    name: Biên dịch StandaloneLinux64 trên máy chủ Linux
    needs: [check-commit]
    if: needs.check-commit.outputs.cancel == 'false'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        targetPlatform:
          - StandaloneLinux64
        scriptingBackend:
          - Mono # 0
          - IL2CPP # 1 
    permissions:
      actions: write
    steps: 
      - name: Clone pk9r327/Dragonboy branch Unity-project
        uses: actions/checkout@v4.1.1
        with:
          repository: pk9r327/Dragonboy
          ref: Unity-project
      - name: Cache
        uses: actions/cache@v4.0.2
        id: cache-restore
        with:
          path: GameProject/DragonBoy/Library
          key: Library-${{ matrix.targetPlatform }}
      - name: Đổi scripting backend thành ${{ matrix.scriptingBackend }}
        run: cd GameProject && chmod +x set_scripting_backend.sh && ./set_scripting_backend.sh "DragonBoy/ProjectSettings/ProjectSettings.asset" "${{ matrix.targetPlatform }}" "${{ matrix.scriptingBackend }}"
      - if: ${{ matrix.targetPlatform == 'Android' }} 
        name: Giải phóng bộ nhớ (Android build)
        uses: jlumbroso/free-disk-space@v1.3.1
      - name: Biên dịch dự án
        uses: game-ci/unity-builder@v4.2.3
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: ${{ matrix.targetPlatform }}
          androidKeystoreName: DragonBoy-pk9r327-UnityProject.keystore # This file won't exist, but this property needs to exist.
          androidKeystoreBase64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          androidKeystorePass: ${{ secrets.ANDROID_KEYSTORE_PASS }}
          androidKeyaliasName: ${{ secrets.ANDROID_KEYALIAS_NAME }}
          androidKeyaliasPass: ${{ secrets.ANDROID_KEYALIAS_PASS }}
          androidTargetSdkVersion: AndroidApiLevel33
          projectPath: GameProject/DragonBoy
          buildName: DragonBoy
          allowDirtyBuild: true
      - name: Upload file game đã biên dịch
        uses: actions/upload-artifact@v4.3.1
        with:
          name: Build-${{ matrix.targetPlatform }}-${{ matrix.scriptingBackend}}
          path: build/${{ matrix.targetPlatform }}
      - name: Xóa cache trước đó
        if: ${{ steps.cache-restore.outputs.cache-hit }}
        continue-on-error: true
        run: |
          gh cache delete "Library-${{ matrix.targetPlatform }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Lưu cache
        uses: actions/cache/save@v4.0.2
        with: 
          path: GameProject/DragonBoy/Library
          key: Library-${{ matrix.targetPlatform }}
  build-Unity-Android:
    name: Biên dịch Android trên máy chủ Linux
    needs: [check-commit]
    if: needs.check-commit.outputs.cancel == 'false'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        targetPlatform:
          - Android
        scriptingBackend:
          - Mono # 0
          - IL2CPP # 1 
    permissions:
      actions: write
    steps: 
      - name: Clone pk9r327/Dragonboy branch Unity-project
        uses: actions/checkout@v4.1.1
        with:
          repository: pk9r327/Dragonboy
          ref: Unity-project
      - name: Cache
        uses: actions/cache@v4.0.2
        id: cache-restore
        with:
          path: GameProject/DragonBoy/Library
          key: Library-${{ matrix.targetPlatform }}-${{ matrix.scriptingBackend }}
      - name: Đổi scripting backend thành ${{ matrix.scriptingBackend }}
        run: cd GameProject && chmod +x set_scripting_backend.sh && ./set_scripting_backend.sh "DragonBoy/ProjectSettings/ProjectSettings.asset" "${{ matrix.targetPlatform }}" "${{ matrix.scriptingBackend }}"
      - if: ${{ matrix.targetPlatform == 'Android' }} 
        name: Giải phóng bộ nhớ (Android build)
        uses: jlumbroso/free-disk-space@v1.3.1
      - name: Biên dịch dự án
        uses: game-ci/unity-builder@v4.2.3
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: ${{ matrix.targetPlatform }}
          androidKeystoreName: DragonBoy-pk9r327-UnityProject.keystore # This file won't exist, but this property needs to exist.
          androidKeystoreBase64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          androidKeystorePass: ${{ secrets.ANDROID_KEYSTORE_PASS }}
          androidKeyaliasName: ${{ secrets.ANDROID_KEYALIAS_NAME }}
          androidKeyaliasPass: ${{ secrets.ANDROID_KEYALIAS_PASS }}
          androidTargetSdkVersion: AndroidApiLevel33
          projectPath: GameProject/DragonBoy
          buildName: DragonBoy
          allowDirtyBuild: true
      - name: Upload file game đã biên dịch
        uses: actions/upload-artifact@v4.3.1
        with:
          name: Build-${{ matrix.targetPlatform }}-${{ matrix.scriptingBackend}}
          path: build/${{ matrix.targetPlatform }}
      - name: Xóa cache trước đó
        if: ${{ steps.cache-restore.outputs.cache-hit }}
        continue-on-error: true
        run: |
          gh cache delete "Library-${{ matrix.targetPlatform }}-${{ matrix.scriptingBackend }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Lưu cache
        uses: actions/cache/save@v4.0.2
        with: 
          path: GameProject/DragonBoy/Library
          key: Library-${{ matrix.targetPlatform }}-${{ matrix.scriptingBackend }}    
  send-artifact-links-announcement:
    name: Gửi link artifact tới Discord webhook
    needs: [build-Unity-Windows, build-Unity-Linux, build-Unity-Android, build-Account-Manager]
    if: ${{ always() && (needs.build-Unity-Windows.result != 'cancelled' && needs.build-Unity-Linux.result != 'cancelled' && needs.build-Unity-Android.result != 'cancelled' && needs.build-Account-Manager.result != 'cancelled') && (needs.build-Unity-Windows.result != 'skipped' && needs.build-Unity-Linux.result != 'skipped' && needs.build-Unity-Android.result != 'skipped' && needs.build-Account-Manager.result != 'skipped') }}
    runs-on: ubuntu-latest
    steps:
      - name: gọi API để lấy link artifact
        id: get_artifact_links
        run: |
          artifactsUrl=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=1 | jq -r '.workflow_runs[0].artifacts_url')
          output="artifact-data="
          output="${output}$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" $artifactsUrl)"
          echo $output >> "$GITHUB_OUTPUT"
      - name: Tạo thông báo để gửi tới Discord webhook
        run: |
          {
            echo 'OUTPUT<<EOF'
            json='${{ steps.get_artifact_links.outputs.artifact-data }}'
            output="Kết quả:"$'\n'
            output="${output}- Biên dịch QLTK: **${{ needs.build-Account-Manager.result }}**"$'\n'
            output="${output}- Biên dịch game cho Windows: **${{ needs.build-Unity-Windows.result }}**"$'\n'
            output="${output}- Biên dịch game cho Linux: **${{ needs.build-Unity-Linux.result }}**"$'\n'
            output="${output}- Biên dịch Game cho Android: **${{ needs.build-Unity-Android.result }}**"$'\n'
            output="${output}$(echo ${json} | jq '.artifacts | length') Artifact:"$'\n'
            end_value=$(($(echo ${json} | jq '.artifacts | length') - 1))
            for i in $(seq 0 $end_value)
            do
              output="${output}- ["
              output="${output}$(echo ${json} | jq -r ".artifacts[${i}].name")"
              output="${output}](https://github.com/${{ github.repository }}/actions/runs/"
              output="${output}$(echo ${json} | jq -r ".artifacts[${i}].workflow_run.id")"
              output="${output}/artifacts/"
              output="${output}$(echo ${json} | jq -r ".artifacts[${i}].id")"
              output=$"${output}"')'$'\n'
            done
            echo "$output" 
            echo EOF
          } >> "$GITHUB_ENV"
      - name: Lấy màu cho thông báo
        run: |
          {
            buildAccountManager="${{ needs.build-Account-Manager.result }}"
            buildUnityLinux="${{ needs.build-Unity-Linux.result }}"
            buildUnityWindows="${{ needs.build-Unity-Windows.result }}"
            buildUnityAndroid="${{ needs.build-Unity-Android.result }}"
            failure_count=0
            if [ "$buildAccountManager" == "failure" ]; then
            ((failure_count++))
            fi
            if [ "$buildUnityLinux" == "failure" ]; then
            ((failure_count++))
            fi
            if [ "$buildUnityWindows" == "failure" ]; then
            ((failure_count++))
            fi
            if [ "$buildUnityAndroid" == "failure" ]; then
            ((failure_count++))
            fi
            echo -n "color="
            if [ "$failure_count" -eq 4 ]; then
                echo "0xff0000"
            elif [ "$failure_count" -eq 3 ]; then
            echo "0xff5a00"
            elif [ "$failure_count" -eq 2 ]; then
                echo "0xffa500"
            elif [ "$failure_count" -eq 1 ]; then
                echo "0xffff00"
            else
                echo "0x00ff00"
            fi
          } >> "$GITHUB_ENV"
      - name: Gửi thông báo tới Discord webhook
        uses: sarisia/actions-status-discord@v1.14.0
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          nodetail: true
          nofail: true
          title: ${{ github.event.repository.name }}
          url: ${{ github.event.repository.html_url }}/actions/runs/${{ github.run_id }}
          color: ${{ env.color }}
          description: |
            ${{ env.OUTPUT }}